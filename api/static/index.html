<!DOCTYPE html>
<html>

<head>
    <title>CV-Job Matching System</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        #log {
            background: #f0f0f0;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #999;
        }

        .status {
            color: blue;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <h1>CV-Job Matching System</h1>

    <div class="container">
        <h2>1. Upload CV</h2>
        <input type="file" id="fileInput">
        <button onclick="uploadCV()">Upload</button>
    </div>

    <div class="container">
        <h2>2. Process</h2>
        <button onclick="startParsing()">Start Parsing</button>
        <button onclick="startMatching()">Find Jobs</button>
    </div>

    <div class="container">
        <h2>3. Evaluation Dashboard</h2>
        <button onclick="runEvaluation()">Run Evaluation</button>
        <div id="evalResults"></div>
    </div>

    <div class="container">
        <h2>Logs</h2>
        <div id="log"></div>
    </div>

    <script>
        let ws = new WebSocket("ws://localhost:8000/ws/process/" + Date.now());
        let currentFilename = "";

        ws.onmessage = function (event) {
            let data = JSON.parse(event.data);
            log(JSON.stringify(data, null, 2), data.status ? "status" : "normal");
        };

        function log(message, type = "normal") {
            let logDiv = document.getElementById("log");
            let p = document.createElement("pre");
            p.textContent = message;
            p.className = type;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function uploadCV() {
            let fileInput = document.getElementById("fileInput");
            let file = fileInput.files[0];
            if (!file) return alert("Please select a file");

            let formData = new FormData();
            formData.append("file", file);

            try {
                let response = await fetch("http://localhost:8000/upload", {
                    method: "POST",
                    body: formData
                });
                let result = await response.json();
                currentFilename = result.filename;
                log("Uploaded: " + currentFilename, "success");
            } catch (e) {
                log("Upload failed: " + e, "error");
            }
        }

        function startParsing() {
            if (!currentFilename) return alert("Upload a CV first");
            ws.send(JSON.stringify({
                type: "parse_cv",
                filename: currentFilename
            }));
        }

        function startMatching() {
            ws.send(JSON.stringify({
                type: "match_jobs"
            }));
        }

        async function runEvaluation() {
            log("Running evaluation... please wait", "status");
            try {
                let response = await fetch("http://localhost:8000/evaluate?count=5", {
                    method: "POST"
                });
                let result = await response.json();
                let evalDiv = document.getElementById("evalResults");
                evalDiv.innerHTML = "<pre>" + JSON.stringify(result.metrics, null, 2) + "</pre>";
                log("Evaluation complete", "success");
            } catch (e) {
                log("Evaluation failed: " + e, "error");
            }
        }
    </script>
</body>

</html>